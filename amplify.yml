version: 1
frontend:
    phases:
        preBuild:
            commands:
                - 'cd frontend'
                - 'npm install' # Install frontend dependencies
        build:
            commands:
                - 'npm run build' # Build the frontend
    artifacts:
        baseDirectory: frontend/build
        files:
            - '**/*'
    cache:
        paths:
            - 'frontend/node_modules/**/*'
    deploy:
        commands:
            # Deploy the frontend
            - echo "Frontend deployment completed. Starting backend deployment..."
            # Write PEM key to a temporary file
            - 'echo "$EC2_PEM_KEY" > ec2-key.pem'
            - 'chmod 600 ec2-key.pem'
            # Copy backend files to EC2
            - 'scp -i ec2-key.pem -r backend/* ec2-user@$EC2_PUBLIC_IP:/home/ec2-user/backend/'
            # SSH into EC2 to set up and restart the backend
            - 'ssh -i ec2-key.pem ec2-user@$EC2_PUBLIC_IP << EOF
                cd /home/ec2-user/backend/
                npm install
                pm2 restart index.js || pm2 start index.js
              EOF'
            # Remove the temporary PEM file
            - 'rm -f ec2-key.pem'
